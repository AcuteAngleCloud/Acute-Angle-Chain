# Genesis Tools: Snapshot


- [Installation](#installation)
	- [Docker](#docker-installation-and-usage)
	- [Manual](#manual-installation)
- [Usage](#manual-install-usage)
- [Development](#development)
- [How it Works](#how-it-works)
	- [High Level](#high-level)
	- [Low Level](#low-level)
- [Logic differences between mainnet and testnet](#difference-between-testnet-and-mainnet)


## Snapshot Generator

### Installation

#### Docker Installation and Usage
_Docker installation is a work in progress_


#### Manual Installation

Manual install is recommended for advanced users only.

#### Prerequisites

1. MySQL
2. Redis-Server
3. Parity 1.7.8 (Recommended) or Geth
4. Node v0.6.X

#### System requirements

1. 8GB Ram Recommended, can make due with 4gb
2. Fast processor recommended
3. SSD recommended

<a name="snapshot-install-manual-config"></a>
### User Configurable Options

There are three methods for configuration
1. *Config File* (recommended)
2. *User Prompt*, fast if your using default mysql, redis and web3 settings.
3. *CLI* args, will override _Prompt_ 

- `period` (integer) The period to sync to, it will sync to the last block of any given period.
- `include_b1` (true, false) Include block.one distribution
- `fallback` (true, false) Use fallback registration
- `cache` (true, false) Will cache successful fallbacks, including full paper trail: Block number, address, transaction, public key and generated AAC key. Can speed up the slow fallback method if running several times.
- `eth_node_type` (http, ipc , ws) [default: http] Based on testing, IPC is recommended for performance
- `eth_node_path` (valid host/path) Relative to type as defined above
- `redis_host`
- `redis_port`
- `mysql_db`
- `mysql_user`
- `mysql_pass`
- `mysql_host`
- `mysql_port`

### Important notes on Parity

Since Parity v1.7.8 `--warp` is enabled by default, it is **absolutely necessary** that you include the flag `--no-warp`. Warping will skip over historical data that the snapshot requires, tricking web3 into thinking the chain is synced when it is not. Warping is useful for miners, whereas for this situation it is poison and will throw errors/produce an inaccurate snapshot. 


### Manual Install Usage

1. Configure using one of three available options
2. Import schema into mysql database, found in `/bin/schema.sql` (Sequalize Migrate presently not configured)
3. Install dependencies `npm install`
4. Make sure all systems are go

	1. Parity is running with RPC ports accessible to application
	2. Mysql is running
	3. Redis is running (`bash: redis-server`)
4. Run script `node snapshot.js` from **project root**
5. Go outside or to bed. 


### Notes

- For your convenience, if web3 is syncing, the app will attempt to start every 30 seconds until it Parity is fully synced
- If parity crashes, you'll need to start over. 


### How it Works


#### High Level

The snapshot parameters this software proposes are as follows

1. All data is constrained by block range determined by period (for testnet)
1. AAC Balance of an address must be greater-than or equal to one AAC to be considered for inclusion in Genesis block
2. An AAC key must be associated to an account either by registration or fallback
3. Contract addresses are not included in the distribution, public keys derived from contracts have no matching private key as the public key is generated by EVM. 
3. If an ethereum address sent AAC ERC20 tokens to the AAC Crowdsale or AAC Token contract within the block range of the snapshot, these tokens are allocated to the respective address. 
4. If an address has unclaimed AAC in the AAC Crowdsale contract within block range, these tokens are allocated to the respective address.


<a name="snapshot-install-manual-about-lowlevel"></a>
#### Low Level

The script employs strict patterns to encourage predictable output, often at the expense of performance. The pattern is *aggregate - calculate - validate* and closely resembles an ETL or _extract, transform and load_ pattern. This decision came after numerous iterations and determining that debugging from state was more efficient than debugging from logs.

Below is the script transposed to plain english.

1. User Configured Parameters are set through one of three methods. 
2. Check Connections to MySQL, Redis and Web3
3. Truncate Databases
4. Generate Period Map
	1. Used to define block ranges of periods
	2. Determines the block range that the snapshot is based upon
5. Set Application State Variables (including user configurations)
5. Sync history of token and crowdsale contract. 
	1. AAC Transfers
	2. Buys
	3. Claims
	4. Registrations
	5. Reclaimable Transfers
2. Compile list of every address that has ever had an AAC balance, for each address:
	1. Aggregate relevant txs
		1. Claims and Buys, required for Unclaimed Balance Calculation
		2. Transfers, all incoming and outgoing tx from address
		3. Reclaimable Transfers, every reclaimable has a corresponding transfer [special case]
		4. The last registration transaction to occur within defined block range
	2. Calculate
		1. Sum Wallet Balance (sum(transfers_in) - sum(transfers_out))
		2. Calculate Unclaimed Balance
		3. Sum Reclaimed Transfer Balances
		4. Sum Balances
		5. Convert balances from gwei
	3. Validate
		1. 	Check Wallet Balance
		2. Validate AAC Key, if valid set `registered` to `true`
		3. If AAC key error, save error to column `register_error`
		4. If all validated, set `valid` to true.
	5. Process
		6. Save every wallet regardless of validation or balance to `wallets` table
	6. Fallback _if `balance is gte 1` and `register_error is not null`_
	   1. Fast Fallback
		   1. Check database for any outgoing transactions (or keys cache), if found...
	   			1.	Query TX and grab Ethereum public key
	   			2. Generate and validate AAC Key
	   			3. If found and valid, set `valid` to `true` otherwise save error into `fallback_error` column
		2. Slow fallback
			1. Obtain list of unique addresses with balance gte 1 AAC and no AAC key and save them as keys in index (redis is used as index)
			2. Scan every `from` value in every transaction transaction included in every block between block 0 to end of block range for snapshot for against  _index_ 
			3. If public key is found, execute fallback registration and revalidate entry, update database row appropriately
    6. Test
    	1. Daily Totals from DB against daily totals from AAC Utility Contract, failure here would not fail the below tests, but would instead result in inaccurate unclaimed balances. Difficult problem to detect without this test. 
    	2. Total Supply, margin of error should be low due to _dust_ from rounding (generally 0.00000001%)
    	3. Negative Balances, there should be **zero** negative balances
    7. Output
    	1. **snapshot.csv** - comma-delimited list of ETH addresses, AAC keys and Total Balances (user, key, balance respectively)
    		1. Move all valid entries from db state to a snapshot table, ordered by balance DESC. 
    		2. Generate snapshot.csv from table
       2. **snapshot.json** - Snapshot meta data

			1. Snapshot parameters
			2. Test results
			3. General Statistics
			4. Generate MD5 Checksums
				1. 	From generated **snapshot.csv** file, useful for debugging and auditing
				2. From mysql checksum for every table in database (useful for debugging)
			5. Pass any other useful state variables into object 

With the output, you can use the Genesis Generator to create a well-formed genesis.json file for the AAC platform. 

<a name="snapshot-development"></a>
### Development

- Do all you work in a separate branch, and submit a pull request. PR's containing changes to snapshot.csv will not be accepted without proof of accuracy and detailed information on the anomaly that was solved.  
- Write your own snapshot script! Use the same high level parameters and see if your generated snapshot.csv is the same checksum as the one generated by this script. This script was written as a baseline, where accuracy and ability to extend as a service were priority. Write a faster one.
- Share your results or ask questions in [Telegram](https://t.me/joinchat/GgxZkRDT3PF5tVFm9m06gw)

<a name="snapshot-networks"></a>
### Difference between Testnet and Mainnet

There are some differences between testnet and mainnet snapshots that need to be mentioned.

- Testnet snapshots will produce accurate output based on period by constraining all blockchain activity to that range. This means that some seemingly superfluous calculations are conducted for testnet
	- Balances are calculated cumulatively, instead of using `balanceOf` method in Token Contract
	- AAC Key Registration is concluded by last registration within the block range. 
- Mainnet simplifies a few things. However, it would be recommended that a cutoff block be enforced to encourage network consensus (primarily for registration transactions)
	- Balances are not calculated but inferred from state returned by `balanceOf` function in Token Contract.
	- AAC key registration is inferred from state returned by `keys` map in Crowdsale Contract. 
